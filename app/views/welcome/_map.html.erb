<script type="text/javascript">
  function initialize() {
    //--create map 
    var myLatlng = new google.maps.LatLng(<%=session[:location_point][0]%>, <%=session[:location_point][1]%>);
    var myOptions = {
      zoom: 18,
      center: myLatlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    //----------------------------------------------end
    //--add info windows
    //see: http://gmaps-samples-v3.googlecode.com/svn/trunk/single-infowindow/single-infowindow.html
    var infoWindow = new google.maps.InfoWindow;
   
    google.maps.event.addListener(map, 'click', function() {
      infoWindow.close();
    });
    //-----------------------------------------------end

     //--json 
    $.getJSON('/welcome/map_data', function(data) {
      var items = [];

      $.each(data, function(key, val) {
        var val_arr = val.split('|');
        items.push('<li id="' + key + '"><a href="/shops/' + val_arr[0] + '">' + val_arr[1] + '</a></li>');

        var marker = new google.maps.Marker({
          position: new google.maps.LatLng(parseFloat(val_arr[2]) , parseFloat(val_arr[3])),
          map: map,
          title: val_arr[1]
        });
        //add info windows listener
        google.maps.event.addListener(marker, 'click', function() {
          var marker = this;
          var latLng = marker.getPosition();
          infoWindow.setContent('<h3>' + val_arr[1] + '<a id="' + val_arr[0] +'" class="happy_shop">加到最爱</a></h3>' +
              latLng.lat() + ', ' + latLng.lng() + ', ' );

          infoWindow.open(map, marker);
        });
      });

      $('<ul/>', {
        'class': 'my-new-list',
        html: items.join('')
      }).appendTo('#side_bar_content');
    });

  }//end initialize

  google.maps.event.addDomListener(window, 'load', initialize);

  
</script>


<div id="map_canvas" style="width:100%; height:600px"></div>

